name: Deploy to Beamup (CLI Method)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üõ† Install Beamup CLI
        run: npm install -g beamup-cli

      - name: ‚öôÔ∏è Configure Beamup
        run: |
          # Configura la CLI come se fossimo sul tuo PC
          beamup config url https://a.baby-beamup.club/
          beamup config hostname git.baby-beamup.club
          
          # Aggiunge l'host ai known_hosts per evitare blocchi
          mkdir -p ~/.ssh
          ssh-keyscan -H git.baby-beamup.club >> ~/.ssh/known_hosts

      - name: üöÄ Deploy via CLI
        env:
          # Passiamo le variabili d'ambiente necessarie
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          INDEXER_URL: ${{ secrets.INDEXER_URL }}
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # 1. Creiamo il file .env (necessario per la CLI)
          echo "Generazione .env..."
          echo "DB_HOST=$DB_HOST" > .env
          echo "DB_PORT=$DB_PORT" >> .env
          echo "DB_NAME=$DB_NAME" >> .env
          echo "DB_USER=$DB_USER" >> .env
          echo "DB_PASSWORD=$DB_PASSWORD" >> .env
          echo "INDEXER_URL=$INDEXER_URL" >> .env
          echo "TMDB_API_KEY=$TMDB_API_KEY" >> .env
          echo "DATABASE_URL=$DATABASE_URL" >> .env

          # 2. Eseguiamo il deploy usando la CLI
          # La CLI cercher√† di capire chi sei tramite la chiave SSH caricata
          echo "Avvio deploy per il progetto: ${{ secrets.PROJECT_NAME }}"
          
          # Forziamo il deploy. Se il progetto non esiste, la CLI potrebbe fallire
          # ma ci dar√† un errore molto pi√π chiaro di "Permission denied".
          beamup deploy
