name: Deploy to Beamup

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Generate Beamup Hash
        id: hash
        run: |
          # Usiamo tr per sicurezza sulla conversione minuscola
          HASH=$(echo "${{ secrets.USERNAME_GITHUB }}" | tr '[:upper:]' '[:lower:]' | shasum -a 256 | cut -c1-12)
          echo "USER_HASH=$HASH" >> $GITHUB_ENV
          echo "Generated Hash: $HASH"

      - name: Configure Beamup Remote
        run: |
          # Saltiamo mkdir perché la cartella esiste già grazie all'azione precedente.
          # Aggiungiamo l'host ai known_hosts direttamente.
          ssh-keyscan -H ${{ secrets.BEAMUP_HOST }} >> ~/.ssh/known_hosts
          
          # Costruiamo l'URL del remote
          REMOTE_URL="dokku@${{ secrets.BEAMUP_HOST }}:${{ env.USER_HASH }}/${{ secrets.PROJECT_NAME }}"
          git remote add beamup "$REMOTE_URL" || git remote set-url beamup "$REMOTE_URL"

      - name: Create Env and Push
        run: |
          # Creazione file .env pulita
          cat <<EOF > .env
          DB_HOST=${{ secrets.ENV_DB_HOST }}
          DB_PORT=${{ secrets.ENV_DB_PORT }}
          DB_NAME=${{ secrets.ENV_DB_NAME }}
          DB_USER=${{ secrets.ENV_DB_USER }}
          DB_PASSWORD=${{ secrets.ENV_DB_PASSWORD }}
          INDEXER_URL=${{ secrets.ENV_INDEXER_URL }}
          NODE_ENV=production
          EOF

          # Configurazione Git standard
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # Aggiunta .env e deploy
          git add .env -f
          git commit -m "Deploy with env vars [skip ci]" || echo "Nessuna modifica"
          
          # Il push forzato verso master è ciò che scatena il build su Beamup (Dokku)
          git push beamup HEAD:master --force
