name: Deploy to Beamup

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Generate Beamup Hash
        id: hash
        run: |
          USER_NAME="${{ secrets.USERNAME_GITHUB }}"
          # Calcolo hash ufficiale
          HASH=$(echo "$USER_NAME" | tr '[:upper:]' '[:lower:]' | shasum -a 256 | cut -c1-12)
          echo "USER_HASH=$HASH" >> $GITHUB_ENV

      - name: Prepare and Push to Beamup
        env:
          BEAMUP_HOST: ${{ secrets.BEAMUP_HOST }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
        run: |
          # 1. Configurazione Git
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # 2. Creazione .env
          cat <<EOF > .env
          DB_HOST=${{ secrets.ENV_DB_HOST }}
          DB_PORT=${{ secrets.ENV_DB_PORT }}
          DB_NAME=${{ secrets.ENV_DB_NAME }}
          DB_USER=${{ secrets.ENV_DB_USER }}
          DB_PASSWORD=${{ secrets.ENV_DB_PASSWORD }}
          INDEXER_URL=${{ secrets.ENV_INDEXER_URL }}
          NODE_ENV=production
          EOF

          # 3. Commit del file .env
          git add .env -f
          git commit -m "Deploy with env vars [skip ci]" || echo "Nessuna modifica"

          # 4. IL FIX: Ignoriamo il controllo dell'host per non rimanere appesi
          # Aggiungiamo -v per il debug in caso di errore
          export GIT_SSH_COMMAND="ssh -v -o StrictHostKeyChecking=no"
          
          REMOTE_URL="dokku@$BEAMUP_HOST:${{ env.USER_HASH }}/$PROJECT_NAME"
          
          echo "Avvio push su: $REMOTE_URL"
          git push "$REMOTE_URL" HEAD:master --force
