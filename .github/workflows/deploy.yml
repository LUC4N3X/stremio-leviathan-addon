name: Deploy to Beamup

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Generate Beamup Hash
        id: hash
        run: |
          # Calcolo hash con fallback se il segreto è vuoto
          USER_NAME="${{ secrets.USERNAME_GITHUB }}"
          if [ -z "$USER_NAME" ]; then echo "Errore: USERNAME_GITHUB mancante"; exit 1; fi
          
          HASH=$(echo "$USER_NAME" | tr '[:upper:]' '[:lower:]' | shasum -a 256 | cut -c1-12)
          echo "USER_HASH=$HASH" >> $GITHUB_ENV

      - name: Deploy to Beamup
        env:
          BEAMUP_HOST: ${{ secrets.BEAMUP_HOST }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
        run: |
          # 1. Configurazione Git identità
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # 2. Setup SSH "Senza Mani": Ignora il controllo dell'host key per evitare errori di permessi su ~/.ssh
          export GIT_SSH_COMMAND="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

          # 3. Creazione .env
          cat <<EOF > .env
          DB_HOST=${{ secrets.ENV_DB_HOST }}
          DB_PORT=${{ secrets.ENV_DB_PORT }}
          DB_NAME=${{ secrets.ENV_DB_NAME }}
          DB_USER=${{ secrets.ENV_DB_USER }}
          DB_PASSWORD=${{ secrets.ENV_DB_PASSWORD }}
          INDEXER_URL=${{ secrets.ENV_INDEXER_URL }}
          NODE_ENV=production
          EOF

          # 4. Commit del file .env
          git add .env -f
          git commit -m "Deploy with env vars [skip ci]" || echo "No changes"

          # 5. Push diretto usando l'URL completo (evita problemi di 'git remote add')
          REMOTE_URL="dokku@$BEAMUP_HOST:${{ env.USER_HASH }}/$PROJECT_NAME"
          git push "$REMOTE_URL" HEAD:master --force
